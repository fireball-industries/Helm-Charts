# Production Grafana + Loki Deployment Example
# High-availability configuration with proper resource allocation

namespace:
  name: grafana-loki-prod
  create: true

pod:
  replicaCount: 1
  
  serviceAccount:
    create: true

# Grafana Configuration
grafana:
  enabled: true
  
  image:
    repository: grafana/grafana
    tag: "10.2.3"
    pullPolicy: IfNotPresent
  
  admin:
    user: "admin"
    password: ""  # Will be auto-generated and stored in secret
  
  config:
    plugins: "grafana-piechart-panel,grafana-worldmap-panel"  # Add useful plugins
    log:
      level: "warn"  # Less verbose for production
    analytics:
      reportingEnabled: false
      checkForUpdates: false
  
  resources:
    preset: large  # Production-grade resources
  
  persistence:
    enabled: true
    storageClass: "fast-ssd"  # Use fast storage for dashboards
    size: "20Gi"

# Loki Configuration
loki:
  enabled: true
  
  image:
    repository: grafana/loki
    tag: "2.9.3"
    pullPolicy: IfNotPresent
  
  config:
    server:
      logLevel: "warn"
    
    limits:
      # Production ingestion limits
      ingestionRateMb: 20
      ingestionBurstSizeMb: 40
      maxGlobalStreamsPerUser: 50000
      
      # Extended retention for production
      retentionPeriod: "2160h"  # 90 days
      maxQueryLookback: "2160h"
      
      # Higher query limits
      maxQuerySeries: 5000
      maxEntriesLimitPerQuery: 50000
    
    compactor:
      enabled: true
      compactionInterval: "5m"  # More frequent compaction
      retentionEnabled: true
      retentionDeleteDelay: "1h"
      retentionDeleteWorkerCount: 200
  
  resources:
    preset: large  # Production log volumes
  
  persistence:
    enabled: true
    storageClass: "standard-ssd"  # Balance cost and performance
    size: "200Gi"  # Larger for 90-day retention

# Service Configuration
service:
  grafana:
    type: LoadBalancer
    annotations:
      # Example: AWS load balancer annotations
      # service.beta.kubernetes.io/aws-load-balancer-type: "nlb"
      # service.beta.kubernetes.io/aws-load-balancer-internal: "true"
  
  loki:
    type: ClusterIP  # Internal only

# Ingress for Grafana
ingress:
  enabled: true
  className: "nginx"
  annotations:
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
  hosts:
    - host: grafana.example.com
      paths:
        - path: /
          pathType: Prefix
  tls:
    - secretName: grafana-tls
      hosts:
        - grafana.example.com

# Node Placement
nodeSelector:
  node-role.kubernetes.io/observability: "true"

tolerations:
  - key: "observability"
    operator: "Equal"
    value: "true"
    effect: "NoSchedule"

affinity:
  podAntiAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        podAffinityTerm:
          labelSelector:
            matchExpressions:
              - key: app.kubernetes.io/name
                operator: In
                values:
                  - grafana-loki-pod
          topologyKey: kubernetes.io/hostname

# Monitoring
monitoring:
  enabled: true
  serviceMonitor:
    enabled: true
    interval: "30s"
    labels:
      prometheus: kube-prometheus

# Pod Disruption Budget
podDisruptionBudget:
  enabled: true
  minAvailable: 1

# Network Policies
networkPolicy:
  enabled: true
