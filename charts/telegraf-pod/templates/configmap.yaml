apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "telegraf.fullname" . }}-config
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "telegraf.labels" . | nindent 4 }}
  annotations:
    fireball.industries/config-complexity: "surprisingly manageable"
    fireball.industries/yaml-nesting-level: "only moderately absurd"
data:
  telegraf.conf: |
    # Telegraf Configuration
    # Generated by Fireball Industries Telegraf Pod
    # We Play With Fire So You Don't Have Toâ„¢
    #
    # This configuration is the result of years of production experience,
    # countless incidents, and one unforgettable outage involving a typo.
    # Learn from our pain.

    ###############################################################################
    #                            GLOBAL AGENT CONFIG                              #
    ###############################################################################

    [agent]
      ## Default data collection interval for all inputs
      interval = "{{ if eq .Values.resourcePreset "custom" }}{{ .Values.config.agent.interval }}{{ else }}{{ (index .Values.resourcePresets .Values.resourcePreset).collectionInterval }}{{ end }}"
      
      ## Rounds collection interval to 'interval'
      ## ie, if interval="10s" then always collect on :00, :10, :20, etc.
      round_interval = {{ .Values.config.agent.round_interval }}

      ## Telegraf will send metrics to outputs in batches of at most
      ## metric_batch_size metrics.
      metric_batch_size = {{ .Values.config.agent.metric_batch_size }}

      ## Maximum number of unwritten metrics per output.
      metric_buffer_limit = {{ if eq .Values.resourcePreset "custom" }}{{ .Values.config.agent.metric_buffer_limit }}{{ else }}{{ (index .Values.resourcePresets .Values.resourcePreset).metricBufferLimit }}{{ end }}

      ## Collection jitter is used to jitter the collection by a random amount.
      ## Each plugin will sleep for a random time within jitter before collecting.
      collection_jitter = "{{ .Values.config.agent.collection_jitter }}"

      ## Default flushing interval for all outputs.
      flush_interval = "{{ if eq .Values.resourcePreset "custom" }}{{ .Values.config.agent.flush_interval }}{{ else }}{{ (index .Values.resourcePresets .Values.resourcePreset).flushInterval }}{{ end }}"
      
      ## Jitter the flush interval by a random amount.
      flush_jitter = "{{ .Values.config.agent.flush_jitter }}"

      ## Override default hostname, if empty use os.Hostname()
      {{- if .Values.config.agent.hostname }}
      hostname = "{{ .Values.config.agent.hostname }}"
      {{- else }}
      hostname = "$HOSTNAME"
      {{- end }}
      
      ## If set to true, do no set the "host" tag in the telegraf agent.
      omit_hostname = {{ .Values.config.agent.omit_hostname }}

    ###############################################################################
    #                              OUTPUT PLUGINS                                 #
    ###############################################################################

    {{- if .Values.config.outputs.influxdb_v2.enabled }}
    ## InfluxDB v2 Output Plugin
    ## For when you want your metrics in a time-series database that actually scales
    [[outputs.influxdb_v2]]
      urls = {{ .Values.config.outputs.influxdb_v2.urls | toJson }}
      token = "{{ .Values.config.outputs.influxdb_v2.token }}"
      organization = "{{ .Values.config.outputs.influxdb_v2.organization }}"
      bucket = "{{ .Values.config.outputs.influxdb_v2.bucket }}"
      timeout = "{{ .Values.config.outputs.influxdb_v2.timeout }}"
      
      ## HTTP User-Agent
      user_agent = "telegraf-fireball-pod/1.0"
      
      ## Optional TLS Config for self-signed certs
      # tls_ca = "/etc/telegraf/ca.pem"
      # tls_cert = "/etc/telegraf/cert.pem"
      # tls_key = "/etc/telegraf/key.pem"
      # insecure_skip_verify = false
    {{- end }}

    {{- if .Values.config.outputs.influxdb_v1.enabled }}
    ## InfluxDB v1 Output Plugin
    ## For those still living in the past (no judgment, we've all been there)
    [[outputs.influxdb]]
      urls = {{ .Values.config.outputs.influxdb_v1.urls | toJson }}
      database = "{{ .Values.config.outputs.influxdb_v1.database }}"
      {{- if .Values.config.outputs.influxdb_v1.username }}
      username = "{{ .Values.config.outputs.influxdb_v1.username }}"
      {{- end }}
      {{- if .Values.config.outputs.influxdb_v1.password }}
      password = "{{ .Values.config.outputs.influxdb_v1.password }}"
      {{- end }}
      {{- if .Values.config.outputs.influxdb_v1.retention_policy }}
      retention_policy = "{{ .Values.config.outputs.influxdb_v1.retention_policy }}"
      {{- end }}
      
      ## Write timeout
      timeout = "5s"
      
      ## HTTP User-Agent
      user_agent = "telegraf-fireball-pod/1.0"
    {{- end }}

    {{- if .Values.config.outputs.prometheus_client.enabled }}
    ## Prometheus Client Output Plugin
    ## Expose metrics for Prometheus to scrape (because pull > push, allegedly)
    [[outputs.prometheus_client]]
      ## Address to listen on
      listen = "{{ .Values.config.outputs.prometheus_client.listen }}"
      
      ## Metric version controls the mapping from Telegraf metrics into
      ## Prometheus format.
      metric_version = 2
      
      ## Use HTTP Basic Authentication.
      # basic_username = "Foo"
      # basic_password = "Bar"
      
      ## If set, the IP Ranges which are allowed to access metrics.
      ##   ex: ip_range = ["192.168.0.0/24", "192.168.1.0/30"]
      # ip_range = []
      
      ## Path to publish the metrics on.
      path = "{{ .Values.config.outputs.prometheus_client.path }}"
      
      ## Expiration interval for each metric.
      expiration_interval = "{{ .Values.config.outputs.prometheus_client.expiration_interval }}"
      
      ## Collectors to enable, valid entries are "gocollector" and "process".
      {{- if .Values.config.outputs.prometheus_client.collectors_exclude }}
      collectors_exclude = {{ .Values.config.outputs.prometheus_client.collectors_exclude | toJson }}
      {{- end }}
      
      ## Send string metrics as Prometheus labels.
      string_as_label = true
    {{- end }}

    {{- if .Values.config.outputs.file.enabled }}
    ## File Output Plugin
    ## For debugging or when you want metrics in a file for some reason
    ## (We don't judge your architecture decisions... much)
    [[outputs.file]]
      files = {{ .Values.config.outputs.file.files | toJson }}
      
      ## Data format to output
      data_format = "{{ .Values.config.outputs.file.data_format }}"
      
      ## Maximum size of rotated files
      rotation_max_size = "{{ .Values.config.outputs.file.rotation_max_size }}"
      
      ## Maximum number of rotated archives to keep
      rotation_max_archives = {{ .Values.config.outputs.file.rotation_max_archives }}
    {{- end }}

    ###############################################################################
    #                              INPUT PLUGINS                                  #
    ###############################################################################

    {{- if .Values.config.inputs.internal.enabled }}
    ## Telegraf Internal Metrics
    ## Monitor the monitor (it's monitoring all the way down)
    [[inputs.internal]]
      collect_memstats = {{ .Values.config.inputs.internal.collect_memstats }}
    {{- end }}

    {{- if .Values.config.inputs.cpu.enabled }}
    ## CPU Input Plugin
    ## Because you need to know when your CPU is on fire
    [[inputs.cpu]]
      percpu = {{ .Values.config.inputs.cpu.percpu }}
      totalcpu = {{ .Values.config.inputs.cpu.totalcpu }}
      collect_cpu_time = {{ .Values.config.inputs.cpu.collect_cpu_time }}
      report_active = {{ .Values.config.inputs.cpu.report_active }}
    {{- end }}

    {{- if .Values.config.inputs.disk.enabled }}
    ## Disk Input Plugin
    ## Track disk usage before you run out of space (again)
    [[inputs.disk]]
      ## Ignore mount points by filesystem type.
      ignore_fs = {{ .Values.config.inputs.disk.ignore_fs | toJson }}
    {{- end }}

    {{- if .Values.config.inputs.diskio.enabled }}
    ## Disk I/O Input Plugin
    ## For when you need to know why everything is slow
    [[inputs.diskio]]
      ## Devices to collect stats for
      ## Wildcards are supported
      # devices = ["sda", "sdb"]
    {{- end }}

    {{- if .Values.config.inputs.kernel.enabled }}
    ## Kernel Input Plugin
    ## Deep kernel metrics for the truly paranoid
    [[inputs.kernel]]
    {{- end }}

    {{- if .Values.config.inputs.mem.enabled }}
    ## Memory Input Plugin
    ## Because OOMKiller is not your friend
    [[inputs.mem]]
    {{- end }}

    {{- if .Values.config.inputs.net.enabled }}
    ## Network Input Plugin
    ## Track network stats before your bandwidth bill arrives
    [[inputs.net]]
      {{- if .Values.config.inputs.net.interfaces }}
      interfaces = {{ .Values.config.inputs.net.interfaces | toJson }}
      {{- end }}
    {{- end }}

    {{- if .Values.config.inputs.processes.enabled }}
    ## Processes Input Plugin
    ## Count all the things running on your system
    [[inputs.processes]]
    {{- end }}

    {{- if .Values.config.inputs.swap.enabled }}
    ## Swap Input Plugin
    ## For when RAM is just a suggestion
    [[inputs.swap]]
    {{- end }}

    {{- if .Values.config.inputs.system.enabled }}
    ## System Input Plugin
    ## General system stats that don't fit anywhere else
    [[inputs.system]]
    {{- end }}

    {{- if and .Values.config.inputs.docker.enabled .Values.hostVolumes.enabled }}
    ## Docker Input Plugin
    ## Monitor your containers monitoring your infrastructure
    [[inputs.docker]]
      endpoint = "{{ .Values.config.inputs.docker.endpoint }}"
      
      ## Timeout for docker list & stat calls
      timeout = "{{ .Values.config.inputs.docker.timeout }}"
      
      ## Whether to report for each container per device or total stats
      perdevice = {{ .Values.config.inputs.docker.perdevice }}
      total = {{ .Values.config.inputs.docker.total }}
      
      ## Whether to get stats for services
      gather_services = {{ .Values.config.inputs.docker.gather_services }}
    {{- end }}

    {{- if and .Values.config.inputs.kubernetes.enabled (eq .Values.deploymentMode "daemonset") }}
    ## Kubernetes Input Plugin
    ## For node-level Kubernetes metrics (DaemonSet mode only, obviously)
    [[inputs.kubernetes]]
      url = "{{ .Values.config.inputs.kubernetes.url }}"
      bearer_token = "{{ .Values.config.inputs.kubernetes.bearer_token }}"
      insecure_skip_verify = {{ .Values.config.inputs.kubernetes.insecure_skip_verify }}
    {{- end }}

    {{- if .Values.config.inputs.kube_inventory.enabled }}
    ## Kubernetes Inventory Plugin
    ## Cluster-wide Kubernetes resource metrics
    ## Warning: May cause metrics explosion
    [[inputs.kube_inventory]]
      url = "{{ .Values.config.inputs.kube_inventory.url }}"
      bearer_token = "{{ .Values.config.inputs.kube_inventory.bearer_token }}"
      insecure_skip_verify = {{ .Values.config.inputs.kube_inventory.insecure_skip_verify }}
      
      {{- if .Values.config.inputs.kube_inventory.namespace }}
      namespace = "{{ .Values.config.inputs.kube_inventory.namespace }}"
      {{- end }}
      
      ## Resource types to collect
      resource_include = {{ .Values.config.inputs.kube_inventory.resource_include | toJson }}
    {{- end }}

    {{- if and .Values.config.inputs.prometheus.enabled (gt (len .Values.config.inputs.prometheus.urls) 0) }}
    ## Prometheus Input Plugin
    ## Scrape Prometheus endpoints (yo dawg, I heard you like metrics)
    [[inputs.prometheus]]
      urls = {{ .Values.config.inputs.prometheus.urls | toJson }}
      
      ## Metric version controls the mapping from Prometheus metrics into Telegraf
      metric_version = 2
    {{- end }}

    ###############################################################################
    #                         PROCESSOR PLUGINS                                   #
    ###############################################################################

    ## Add Fireball Industries branding to all metrics
    ## Because every metric deserves a touch of professionalism
    [[processors.enum]]
      [[processors.enum.mapping]]
        ## Tag to map
        tag = "vendor"
        
        [processors.enum.mapping.value_mappings]
          fireball = "Fireball Industries - {{ .Values.fireball.slogan }}"

    ###############################################################################
    #                         AGGREGATOR PLUGINS                                  #
    ###############################################################################

    ## No aggregators enabled by default
    ## Because sometimes raw data is what you need

    ###############################################################################
    #                            END OF CONFIG                                    #
    ###############################################################################
    
    ## Congratulations! You've reached the end of the configuration file.
    ## If you're reading this, you're either:
    ## 1. Debugging something that's broken
    ## 2. Checking if we actually know what we're doing
    ## 3. Really, really bored
    ##
    ## May your metrics be plentiful and your cardinality reasonable.
    ## - The Fireball Industries Team
