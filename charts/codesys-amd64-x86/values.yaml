# Default values for codesys-x86 Helm chart
# This is a YAML-formatted file.
# Declare variables to be passed into your templates.

# CODESYS runtime configuration
codesys:
  version: "4.18.0.0"
  
# Architecture selection - choose 'amd64' or '386'
# Only one architecture deployment will be active
architecture: amd64

# Image configuration
# GitHub Release: https://github.com/fireball-industries/CodesysControlLinuxAMD64X86/releases/tag/AMD64-X86
image:
  registry: ghcr.io
  repository: fireball-industries/codesys-runtime-amd64
  pullPolicy: Always
  # Overrides the image tag whose default is the chart appVersion.
  tag: "4.18.0.0"

# Image pull secrets for private registries
imagePullSecrets: []
# - name: regcred

# Namespace configuration
namespace:
  name: codesys-x86
  create: true
  labels:
    architecture: x86
    description: "CODESYS Control for Linux - x86 Architecture"

# Service Account
serviceAccount:
  # Specifies whether a service account should be created
  create: false
  # Annotations to add to the service account
  annotations: {}
  # The name of the service account to use.
  name: ""

# Deployment configuration
replicaCount: 1

# Pod annotations
podAnnotations: {}

# Pod security context
podSecurityContext:
  fsGroup: 1000

# Container security context
securityContext:
  capabilities:
    add:
      - SYS_NICE
      - NET_RAW
      - NET_ADMIN
      - SYS_TIME
  runAsUser: 1000
  runAsGroup: 1000
  allowPrivilegeEscalation: false
  # runAsNonRoot: true

# Resource limits and requests
resources:
  # For amd64 architecture
  amd64:
    limits:
      cpu: 1000m
      memory: 1Gi
    requests:
      cpu: 250m
      memory: 256Mi
  # For 386 architecture
  i386:
    limits:
      cpu: 500m
      memory: 512Mi
    requests:
      cpu: 100m
      memory: 128Mi

# Node selector for architecture
nodeSelector:
  # Will be automatically set based on 'architecture' value
  # kubernetes.io/arch: amd64

# Tolerations
tolerations: []

# Affinity rules
affinity: {}

# Service configuration
service:
  type: NodePort
  # Annotations for the service
  annotations: {}
  
  # PLC communication port
  plc:
    port: 11740
    targetPort: 11740
    nodePort: 31740
    protocol: TCP
  
  # Web visualization port
  webvisu:
    port: 2455
    targetPort: 2455
    nodePort: 32455
    protocol: TCP
  
  # OPC UA port
  opcua:
    port: 4840
    targetPort: 4840
    nodePort: 34840
    protocol: TCP

# Persistent storage configuration
persistence:
  # Enable persistence
  enabled: true
  
  # Storage class (leave empty for default)
  storageClass: ""
  
  # Projects volume
  projects:
    enabled: true
    size: 5Gi
    accessMode: ReadWriteOnce
    # existingClaim: ""
  
  # License volume
  license:
    enabled: true
    size: 100Mi
    accessMode: ReadWriteOnce
    # existingClaim: ""

# ConfigMap for runtime configuration
config:
  # CODESYS Control configuration file
  codesysControl: |
    [SysProcess]
    Command.0=locale
    Command.1=ifconfig
    
    [CmpSettings]
    MaxFileSize=10000000
    
    [SysFile]
    PlcLogicPrefix=1
    
    [CmpLog]
    Logger.0.Name=StdOut
    Logger.0.Filter=0x0000000F
    Logger.0.Enable=1
    Logger.0.MaxEntries=1000
    Logger.0.Type=0x314
    
    [CmpApp]
    Application.1=Application
    
    [Application]
    ProjectFile=/var/opt/codesys/projects/Application.app
    BootprojectAutostart=YES
    
    [SysCom]
    Linux.Devicefile=/dev/null
    
    [CmpBlkDrvTcp]
    TcpPort=11740
    MaxChannels=10
    
    [CmpWebServer]
    WebServerPort=2455
    MaxConnections=10
    DefaultPage=webvisu.htm
    
    [CmpOPCUAServer]
    ServerPort=4840
    Enabled=1
    
    [SysSocket]
    Adapter.0.Name=eth0
    Adapter.0.EnableSetIpAndMask=0
  
  # Runtime environment variables
  runtimeEnv: |
    CODESYS_LOG_LEVEL=INFO
    CODESYS_MAX_APPLICATIONS=4
    CODESYS_CYCLE_TIME_MS=10

# Health check probes
livenessProbe:
  enabled: true
  exec:
    command:
      - /bin/sh
      - -c
      - pidof codesyscontrol
  initialDelaySeconds: 60
  periodSeconds: 30
  timeoutSeconds: 10
  failureThreshold: 3

readinessProbe:
  enabled: true
  tcpSocket:
    port: 11740
  initialDelaySeconds: 30
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 3

startupProbe:
  enabled: true
  tcpSocket:
    port: 11740
  initialDelaySeconds: 10
  periodSeconds: 5
  timeoutSeconds: 3
  failureThreshold: 12

# Init container for permission setup
initContainer:
  enabled: true
  image: busybox:latest
  command:
    - sh
    - -c
    - chmod -R 755 /var/opt/codesys/projects && chmod -R 755 /var/opt/codesys/license

# Environment variables
env: []
  # - name: CUSTOM_VAR
  #   value: "custom_value"

# License configuration
# Use this to mount a license file from a Kubernetes Secret
license:
  # Use existing secret for license file
  useSecret: false
  secretName: ""
  # secretKey: license.lic

# ==================== Integration Configurations ====================
# These configurations make it easy to connect your CODESYS PLC to other services
# Note: Actual integration must be implemented in your PLC program using CODESYS libraries

# Database integration configuration
database:
  # Enable database integration (creates environment variables for PLC program)
  enabled: false
  
  # InfluxDB time-series database integration
  influxdb:
    enabled: false
    # Service name in Kubernetes cluster
    host: "influxdb-pod"
    port: 8086
    # Database name
    database: "industrial_data"
    # Authentication (creates secret if credentials provided)
    username: ""
    password: ""
    # Use existing secret
    existingSecret: ""
    # Organization and bucket for InfluxDB v2
    organization: "fireball-industries"
    bucket: "plc_data"
    # PLC Library: Use 'IoTLibrary' or 'OSCAT' InfluxDB client
  
  # TimescaleDB PostgreSQL-compatible time-series database
  timescaledb:
    enabled: false
    # Service name in Kubernetes cluster
    host: "timescaledb-pod"
    port: 5432
    database: "industrial_data"
    # Schema for PLC data tables
    schema: "plc_metrics"
    # Authentication (creates secret if credentials provided)
    username: "postgres"
    password: ""
    # Use existing secret
    existingSecret: ""
    # SSL mode: disable, require, verify-ca, verify-full
    sslMode: "disable"
    # PLC Library: Use 'PostgreSQL' OSCAT library or custom implementation
  
  # PostgreSQL general-purpose relational database
  postgresql:
    enabled: false
    host: "postgresql-pod"
    port: 5432
    database: "codesys_data"
    username: "postgres"
    password: ""
    existingSecret: ""
    sslMode: "disable"
    # PLC Library: Use 'PostgreSQL' OSCAT library or custom implementation

# MQTT broker integration
mqtt:
  # Enable MQTT integration (creates environment variables for PLC program)
  enabled: false
  
  # MQTT broker connection
  broker:
    # Service name in Kubernetes cluster
    host: "mosquitto-mqtt-pod"
    port: 1883
    # Enable SSL/TLS
    tls:
      enabled: false
      port: 8883
    # Authentication
    username: ""
    password: ""
    existingSecret: ""
    # Client ID prefix (runtime will append unique identifier)
    clientIdPrefix: "codesys-x86"
    # Quality of Service (0, 1, 2)
    qos: 1
    # Retain messages
    retain: false
    # Keep alive interval (seconds)
    keepAlive: 60
    # PLC Library: Use 'IoTMQTT' library from CODESYS Store
  
  # Default topics configuration
  topics:
    # Base topic for this PLC
    base: "factory/plc/codesys-x86"
    # Status topic (online/offline)
    status: "factory/plc/codesys-x86/status"
    # Data publishing topic
    data: "factory/plc/codesys-x86/data"
    # Command subscription topic
    command: "factory/plc/codesys-x86/command"

# Prometheus monitoring integration
monitoring:
  # Enable ServiceMonitor for Prometheus Operator
  serviceMonitor:
    enabled: false
    # Namespace where Prometheus is running
    namespace: monitoring
    # Scrape interval
    interval: 30s
    # Scrape timeout
    scrapeTimeout: 10s
    # Metric relabeling
    relabelings: []
    # Additional labels for ServiceMonitor
    labels: {}
    # Note: Requires 'CmpPrometheus' library in CODESYS or custom metrics exporter
  
  # Metrics endpoint configuration (if using CODESYS Prometheus library)
  metrics:
    enabled: false
    # Port for metrics endpoint
    port: 9273
    # Path for metrics
    path: /metrics

# Grafana dashboard provisioning
grafana:
  # Enable dashboard ConfigMap
  dashboards:
    enabled: false
    # Dashboard namespace
    namespace: monitoring
    # Labels for Grafana sidecar discovery
    labels:
      grafana_dashboard: "1"
