# Production Node-RED Deployment Example
# Enterprise-grade configuration with security and reliability

namespace:
  name: node-red-prod
  create: true

pod:
  replicaCount: 1
  
  strategy:
    type: Recreate  # Required for single-replica with RWO PVC
  
  serviceAccount:
    create: true

# Node-RED Configuration
nodeRed:
  image:
    repository: nodered/node-red
    tag: "3.1.0"
    pullPolicy: IfNotPresent
  
  port: 1880
  
  env:
    timezone: "America/New_York"
    enableSafeMode: false
    enableProjects: true
    # Set credential secret for consistent encryption
    credentialSecret: "change-me-to-a-secure-random-string-32chars-long"
  
  # Authentication - REQUIRED for production
  auth:
    enabled: true
    username: "admin"
    # Generate hash: docker run -it nodered/node-red npx node-red admin hash-pw
    passwordHash: "$2b$08$zZWtXTja0fB1pzD4sHCMyOCMYz2Z6dNbM6tl8sJogENOMcxWV9DN."
    # Note: This is a hash of "fireballs" - CHANGE IN PRODUCTION
  
  # Custom settings for production
  settings:
    enabled: true
    custom:
      functionExternalModules: false  # Disable for security in multi-user environments
      
      logging:
        console:
          level: "warn"  # Less verbose for production
          metrics: false
          audit: true  # Enable audit logging
      
      editorTheme:
        projects:
          enabled: true
        palette:
          editable: true  # Allow node installation (be cautious in locked-down environments)
        header:
          title: "Node-RED Production"
      
      contextStorage:
        default:
          module: "localfilesystem"
      
      httpNodeCors:
        origin: "https://example.com"  # Restrict CORS in production
        methods: "GET,PUT,POST,DELETE"
  
  # Production resource allocation
  resources:
    preset: large  # 500m-2000m CPU, 1Gi-4Gi RAM
  
  # Health checks
  livenessProbe:
    enabled: true
    httpGet:
      path: /
      port: 1880
    initialDelaySeconds: 60
    periodSeconds: 30
    timeoutSeconds: 10
    failureThreshold: 3
  
  readinessProbe:
    enabled: true
    httpGet:
      path: /
      port: 1880
    initialDelaySeconds: 30
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 3
  
  # Security context
  securityContext:
    runAsUser: 1000
    runAsGroup: 1000
    fsGroup: 1000
    runAsNonRoot: true
    allowPrivilegeEscalation: false
    readOnlyRootFilesystem: false
    capabilities:
      drop:
        - ALL

# Persistent Storage - Production grade
persistence:
  enabled: true
  storageClass: "longhorn"  # Replicated storage for reliability
  size: "20Gi"
  accessMode: ReadWriteOnce
  mountPath: /data

# Service Configuration
service:
  type: LoadBalancer
  port: 1880
  targetPort: 1880
  protocol: TCP
  
  # Session affinity for WebSocket support
  sessionAffinity: ClientIP
  sessionAffinityConfig:
    clientIP:
      timeoutSeconds: 10800  # 3 hours
  
  annotations:
    # Example AWS annotations
    # service.beta.kubernetes.io/aws-load-balancer-type: "nlb"
    # service.beta.kubernetes.io/aws-load-balancer-internal: "true"

# Ingress for HTTPS access
ingress:
  enabled: true
  className: "nginx"
  annotations:
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
    # WebSocket support
    nginx.ingress.kubernetes.io/websocket-services: "node-red"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "3600"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "3600"
  hosts:
    - host: node-red.example.com
      paths:
        - path: /
          pathType: Prefix
  tls:
    - secretName: node-red-tls
      hosts:
        - node-red.example.com

# Node Placement - Pin to specific nodes
nodeSelector:
  node-role.kubernetes.io/automation: "true"

# Tolerations for dedicated automation nodes
tolerations:
  - key: "automation"
    operator: "Equal"
    value: "true"
    effect: "NoSchedule"

# Anti-affinity (spread across nodes if scaled)
affinity:
  podAntiAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        podAffinityTerm:
          labelSelector:
            matchExpressions:
              - key: app.kubernetes.io/name
                operator: In
                values:
                  - node-red
          topologyKey: kubernetes.io/hostname

# Pod Disruption Budget
podDisruptionBudget:
  enabled: true
  minAvailable: 1

# Network Policy - Restrict access
networkPolicy:
  enabled: true
  policyTypes:
    - Ingress
    - Egress
  
  ingress:
    # Allow ingress controller
    - from:
        - namespaceSelector:
            matchLabels:
              name: ingress-nginx
      ports:
        - protocol: TCP
          port: 1880
    # Allow monitoring
    - from:
        - namespaceSelector:
            matchLabels:
              name: monitoring
      ports:
        - protocol: TCP
          port: 1880
  
  egress:
    # Allow DNS
    - to:
        - namespaceSelector: {}
      ports:
        - protocol: UDP
          port: 53
    # Allow HTTPS
    - to:
        - namespaceSelector: {}
      ports:
        - protocol: TCP
          port: 443
    # Allow HTTP
    - to:
        - namespaceSelector: {}
      ports:
        - protocol: TCP
          port: 80
    # Allow MQTT (if needed)
    - to:
        - namespaceSelector: {}
      ports:
        - protocol: TCP
          port: 1883
        - protocol: TCP
          port: 8883

# Monitoring
monitoring:
  enabled: true
  serviceMonitor:
    enabled: true
    interval: "30s"
    labels:
      prometheus: kube-prometheus

# Backup Configuration (manual for now)
backup:
  enabled: false
  # Future: Implement automated backups to S3/MinIO
  schedule: "0 2 * * *"  # 2 AM daily
  retention: 30  # Keep 30 days
