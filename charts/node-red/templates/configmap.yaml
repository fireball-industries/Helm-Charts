{{- if .Values.nodeRed.settings.enabled -}}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "node-red.settingsConfigMapName" . }}
  namespace: {{ include "node-red.namespace" . }}
  labels:
    {{- include "node-red.labels" . | nindent 4 }}
data:
  settings.js: |
    /**
     * Node-RED Settings
     * Auto-generated by Helm Chart
     * Fireball Industries Podstore
     */

    module.exports = {
        // UI Port
        uiPort: process.env.PORT || {{ .Values.nodeRed.port }},

        // User Directory
        userDir: '{{ .Values.persistence.mountPath }}/',

        // Nodes Directory
        nodesDir: '{{ .Values.persistence.mountPath }}/nodes',

        // Flow File
        flowFile: 'flows.json',

        // Flow File Pretty Print
        flowFilePretty: true,

        // Credential Secret
        {{- if .Values.nodeRed.env.credentialSecret }}
        credentialSecret: {{ .Values.nodeRed.env.credentialSecret | quote }},
        {{- else }}
        credentialSecret: process.env.NODE_RED_CREDENTIAL_SECRET || false,
        {{- end }}

        // Disable Editor
        disableEditor: false,

        // UI Host
        uiHost: "0.0.0.0",

        // CORS Configuration
        {{- if .Values.nodeRed.settings.custom.httpNodeCors }}
        httpNodeCors: {{- toYaml .Values.nodeRed.settings.custom.httpNodeCors | nindent 10 }},
        {{- end }}

        // Static Content
        httpStatic: '{{ .Values.persistence.mountPath }}/static',

        {{- if .Values.nodeRed.auth.enabled }}
        // Authentication
        adminAuth: {
            type: "credentials",
            users: [{
                username: {{ .Values.nodeRed.auth.username | quote }},
                password: {{ include "node-red.passwordHash" . | quote }},
                permissions: "*"
            }]
        },
        {{- end }}

        // Context Storage
        {{- if .Values.nodeRed.settings.custom.contextStorage }}
        contextStorage: {{- toYaml .Values.nodeRed.settings.custom.contextStorage | nindent 10 }},
        {{- end }}

        // Logging
        {{- if .Values.nodeRed.settings.custom.logging }}
        logging: {{- toYaml .Values.nodeRed.settings.custom.logging | nindent 10 }},
        {{- end }}

        // Editor Theme
        {{- if .Values.nodeRed.settings.custom.editorTheme }}
        editorTheme: {{- toYaml .Values.nodeRed.settings.custom.editorTheme | nindent 10 }},
        {{- end }}

        // Function External Modules
        {{- if hasKey .Values.nodeRed.settings.custom "functionExternalModules" }}
        functionExternalModules: {{ .Values.nodeRed.settings.custom.functionExternalModules }},
        {{- end }}

        // Node Message Buffer Max Length
        nodeMessageBufferMaxLength: 0,

        // Debug Use Colors
        debugUseColors: true,

        // MQTT Reconnect Time
        mqttReconnectTime: 15000,

        // Serial Reconnect Time
        serialReconnectTime: 15000,

        // Socket Reconnect Time
        socketReconnectTime: 10000,

        // Socket Timeout
        socketTimeout: 120000,

        // TCP Message Queue Size
        tcpMsgQueueSize: 2000,

        // HTTP Request Timeout
        httpRequestTimeout: 120000,

        // Debug Max Length
        debugMaxLength: 1000,

        // Exec Max Buffer Size
        execMaxBufferSize: 10000000,

        // Flow Stop Timeout
        flowStopTimeout: 10000
    };
{{- end }}
