{{/*
============================================================================
Secrets
============================================================================
Fireball Industries - Patrick Ryan

Secret storage for sensitive data.
These are base64-encoded (not encrypted) in Kubernetes.
For production, consider using:
- External Secrets Operator (AWS Secrets Manager, Azure Key Vault, etc.)
- Sealed Secrets
- HashiCorp Vault
- SOPS (Secrets OPerationS)

Or just YOLO it with plain Kubernetes secrets like everyone else does.
============================================================================
*/}}

{{- if and (eq .Values.database.type "postgresql") .Values.database.postgresql.enabled (not .Values.database.postgresql.auth.existingSecret) }}
---
# ===========================================================================
# PostgreSQL Secret
# ===========================================================================
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "home-assistant.postgresql.secretName" . }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "home-assistant.labels" . | nindent 4 }}
    app.kubernetes.io/component: database
type: Opaque
data:
  {{ .Values.database.postgresql.auth.secretKey }}: {{ .Values.database.postgresql.auth.password | b64enc | quote }}
{{- end }}

{{- if and .Values.mqtt.enabled (not .Values.mqtt.config.existingSecret) (not .Values.mqtt.config.allowAnonymous) }}
---
# ===========================================================================
# MQTT Secret
# ===========================================================================
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "home-assistant.mqtt.secretName" . }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "home-assistant.labels" . | nindent 4 }}
    app.kubernetes.io/component: mqtt
type: Opaque
data:
  username: {{ .Values.mqtt.config.username | b64enc | quote }}
  password: {{ .Values.mqtt.config.password | b64enc | quote }}
{{- end }}

{{- if and .Values.nodered.enabled .Values.nodered.security.enabled (not .Values.nodered.security.existingSecret) }}
---
# ===========================================================================
# Node-RED Secret
# ===========================================================================
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "home-assistant.fullname" . }}-nodered
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "home-assistant.labels" . | nindent 4 }}
    app.kubernetes.io/component: nodered
type: Opaque
data:
  username: {{ .Values.nodered.security.username | b64enc | quote }}
  {{- if .Values.nodered.security.passwordHash }}
  password-hash: {{ .Values.nodered.security.passwordHash | b64enc | quote }}
  {{- end }}
{{- end }}
