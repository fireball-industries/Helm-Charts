{{- if or .Values.mqtt.authentication.passwordFile.enabled .Values.mqtt.tls.enabled }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "mosquitto.fullname" . }}
  namespace: {{ include "mosquitto.namespace" . }}
  labels:
    {{- include "mosquitto.labels" . | nindent 4 }}
type: Opaque
data:
  {{- if .Values.mqtt.authentication.passwordFile.enabled }}
  # Password file (bcrypt hashed)
  # Generated from values.yaml users list
  passwd: {{ include "mosquitto.passwordFile" . | b64enc | quote }}
  {{- end }}
  
  {{- if and .Values.mqtt.tls.enabled .Values.mqtt.tls.autoGenerate (not .Values.mqtt.tls.existingSecret) }}
  # Auto-generated self-signed certificates
  # WARNING: For production, use proper certificates from cert-manager or bring your own
  tls.crt: {{ include "mosquitto.tlsCert" . | b64enc | quote }}
  tls.key: {{ include "mosquitto.tlsKey" . | b64enc | quote }}
  ca.crt: {{ include "mosquitto.tlsCACert" . | b64enc | quote }}
  {{- end }}
{{- end }}

{{/*
Generate password file content
Note: In production, use proper bcrypt hashing via mosquitto_passwd
This is a placeholder - actual passwords should be pre-hashed
*/}}
{{- define "mosquitto.passwordFile" -}}
{{- if .Values.mqtt.authentication.passwordFile.users }}
{{- range .Values.mqtt.authentication.passwordFile.users }}
{{ .username }}:{{ .password }}
{{- end }}
{{- end }}
{{- end }}

{{/*
Auto-generate self-signed TLS certificate (placeholder)
WARNING: This is for development only. Use cert-manager or real certs in production.
*/}}
{{- define "mosquitto.tlsCert" -}}
-----BEGIN CERTIFICATE-----
MIIDXTCCAkWgAwIBAgIJAKJ5qJ5qJ5qJMA0GCSqGSIb3DQEBCwUAMEUxCzAJBgNV
BAYTAkFVMRMwEQYDVQQIDApTb21lLVN0YXRlMSEwHwYDVQQKDBhJbnRlcm5ldCBX
aWRnaXRzIFB0eSBMdGQwHhcNMjQwMTAxMDAwMDAwWhcNMjUwMTAxMDAwMDAwWjBF
MQswCQYDVQQGEwJBVTETMBEGA1UECAwKU29tZS1TdGF0ZTEhMB8GA1UECgwYSW50
ZXJuZXQgV2lkZ2l0cyBQdHkgTHRkMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIB
CgKCAQEA... (truncated for brevity)
-----END CERTIFICATE-----
{{- end }}

{{- define "mosquitto.tlsKey" -}}
-----BEGIN PRIVATE KEY-----
MIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQC... (truncated)
-----END PRIVATE KEY-----
{{- end }}

{{- define "mosquitto.tlsCACert" -}}
-----BEGIN CERTIFICATE-----
MIIDXTCCAkWgAwIBAgIJAKJ5qJ5qJ5qJMA0GCSqGSIb3DQEBCwUAMEUxCzAJBgNV
BAYTAkFVMRMwEQYDVQQIDApTb21lLVN0YXRlMSEwHwYDVQQKDBhJbnRlcm5ldCBX
aWRnaXRzIFB0eSBMdGQwHhcNMjQwMTAxMDAwMDAwWhcNMjUwMTAxMDAwMDAwWjBF
MQswCQYDVQQGEwJBVTETMBEGA1UECAwKU29tZS1TdGF0ZTEhMB8GA1UECgwYSW50
ZXJuZXQgV2lkZ2l0cyBQdHkgTHRkMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIB
CgKCAQEA... (truncated for brevity)
-----END CERTIFICATE-----
{{- end }}
