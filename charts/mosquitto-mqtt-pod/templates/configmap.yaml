apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "mosquitto.fullname" . }}
  namespace: {{ include "mosquitto.namespace" . }}
  labels:
    {{- include "mosquitto.labels" . | nindent 4 }}
data:
  mosquitto.conf: |
{{ include "mosquitto.config" . | indent 4 }}

  {{- if .Values.mqtt.acl.enabled }}
  acl.conf: |
{{ include "mosquitto.acl" . | indent 4 }}
  {{- end }}

  {{- if .Values.mqtt.bridge.enabled }}
  {{- range .Values.mqtt.bridge.connections }}
  bridge-{{ .name }}.conf: |
    # Bridge configuration for {{ .name }}
    connection {{ .name }}
    address {{ .address }}
    {{- range .topics }}
    topic {{ . }}
    {{- end }}
    {{- if .clientId }}
    clientid {{ .clientId }}
    {{- end }}
    {{- if .username }}
    remote_username {{ .username }}
    {{- end }}
    {{- if .password }}
    remote_password {{ .password }}
    {{- end }}
    cleansession {{ .cleanSession }}
    {{- if .tryPrivate }}
    try_private {{ .tryPrivate }}
    {{- end }}
  {{- end }}
  {{- end }}
