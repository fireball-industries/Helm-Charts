apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "alert-manager.configMapName" . }}
  namespace: {{ include "alert-manager.namespace" . }}
  labels:
    {{- include "alert-manager.labels" . | nindent 4 }}
data:
  alertmanager.yml: |
    # Alertmanager Configuration
    # Managed by Fireball Industries Podstore - Patrick Ryan
    
    global:
      resolve_timeout: {{ .Values.config.global.resolve_timeout }}
      
      {{- if .Values.config.global.smtp_smarthost }}
      # Email/SMTP Configuration
      smtp_smarthost: {{ .Values.config.global.smtp_smarthost | quote }}
      smtp_from: {{ .Values.config.global.smtp_from | quote }}
      {{- if .Values.config.global.smtp_auth_username }}
      smtp_auth_username: {{ .Values.config.global.smtp_auth_username | quote }}
      {{- end }}
      {{- if .Values.config.global.smtp_auth_password }}
      smtp_auth_password: {{ .Values.config.global.smtp_auth_password | quote }}
      {{- end }}
      smtp_require_tls: {{ .Values.config.global.smtp_require_tls }}
      {{- end }}
      
      {{- if .Values.config.global.slack_api_url }}
      # Slack Configuration
      slack_api_url: {{ .Values.config.global.slack_api_url | quote }}
      {{- end }}
      
      {{- if .Values.config.global.pagerduty_url }}
      # PagerDuty Configuration
      pagerduty_url: {{ .Values.config.global.pagerduty_url | quote }}
      {{- end }}
    
    # Alert Routing Configuration
    route:
      receiver: {{ .Values.config.route.receiver | quote }}
      group_by: {{ toYaml .Values.config.route.group_by | nindent 8 }}
      group_wait: {{ .Values.config.route.group_wait }}
      group_interval: {{ .Values.config.route.group_interval }}
      repeat_interval: {{ .Values.config.route.repeat_interval }}
      
      # Route specific alerts to different receivers
      routes:
        {{- toYaml .Values.config.route.routes | nindent 8 }}
    
    # Alert Receivers
    receivers:
      {{- toYaml .Values.config.receivers | nindent 6 }}
    
    # Inhibition Rules
    {{- if .Values.config.inhibit_rules }}
    inhibit_rules:
      {{- toYaml .Values.config.inhibit_rules | nindent 6 }}
    {{- end }}
