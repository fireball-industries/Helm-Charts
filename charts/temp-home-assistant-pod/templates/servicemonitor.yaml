{{- if .Values.monitoring.serviceMonitor.enabled }}
{{/*
============================================================================
Prometheus ServiceMonitor
============================================================================
Fireball Industries - Patrick Ryan

Prometheus ServiceMonitor for scraping Home Assistant metrics.
Requires Prometheus Operator to be installed in the cluster.

Metrics you'll get:
- Home Assistant uptime
- Entity count (how many smart devices you've wasted money on)
- Automation execution times
- API response times
- Database query performance
- Memory/CPU usage

Perfect for obsessing over metrics at 3 AM instead of sleeping.
============================================================================
*/}}

apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: {{ include "home-assistant.fullname" . }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "home-assistant.labels" . | nindent 4 }}
    {{- with .Values.monitoring.serviceMonitor.labels }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
spec:
  selector:
    matchLabels:
      {{- include "home-assistant.selectorLabels" . | nindent 6 }}
  
  endpoints:
    - port: http
      path: /api/prometheus
      interval: {{ .Values.monitoring.serviceMonitor.interval }}
      scrapeTimeout: {{ .Values.monitoring.serviceMonitor.scrapeTimeout }}
      scheme: http
      
      # Bearer token authentication (if required)
      # bearerTokenSecret:
      #   name: homeassistant-prometheus-token
      #   key: token
      
      # Metric relabeling
      metricRelabelings:
        # Drop high-cardinality metrics
        - sourceLabels: [__name__]
          regex: 'homeassistant_sensor_.*'
          action: drop
      
      # Relabeling
      relabelings:
        - sourceLabels: [__meta_kubernetes_pod_name]
          targetLabel: pod
        - sourceLabels: [__meta_kubernetes_pod_node_name]
          targetLabel: node
        - sourceLabels: [__meta_kubernetes_namespace]
          targetLabel: namespace

---
{{- if eq .Values.database.type "postgresql" }}
# ===========================================================================
# ServiceMonitor for PostgreSQL
# ===========================================================================
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: {{ include "home-assistant.fullname" . }}-postgresql
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "home-assistant.labels" . | nindent 4 }}
    app.kubernetes.io/component: database
    {{- with .Values.monitoring.serviceMonitor.labels }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
spec:
  selector:
    matchLabels:
      {{- include "home-assistant.selectorLabels" . | nindent 6 }}
      app.kubernetes.io/component: database
  
  endpoints:
    - port: postgresql
      interval: {{ .Values.monitoring.serviceMonitor.interval }}
      scrapeTimeout: {{ .Values.monitoring.serviceMonitor.scrapeTimeout }}
      scheme: http
{{- end }}

---
{{- if and .Values.mqtt.enabled (eq .Values.mqtt.deployment "separate") }}
# ===========================================================================
# ServiceMonitor for MQTT Broker
# ===========================================================================
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: {{ include "home-assistant.fullname" . }}-mqtt
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "home-assistant.labels" . | nindent 4 }}
    app.kubernetes.io/component: mqtt
    {{- with .Values.monitoring.serviceMonitor.labels }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
spec:
  selector:
    matchLabels:
      {{- include "home-assistant.selectorLabels" . | nindent 6 }}
      app.kubernetes.io/component: mqtt
  
  endpoints:
    - port: mqtt
      interval: {{ .Values.monitoring.serviceMonitor.interval }}
      scrapeTimeout: {{ .Values.monitoring.serviceMonitor.scrapeTimeout }}
      scheme: http
{{- end }}

{{- end }}
